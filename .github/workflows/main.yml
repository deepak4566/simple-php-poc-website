name: Deploy to Google Cloud Instance

on:
  push:
    

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies and fix libcrypto error
      run: |
        # Install required packages
        sudo apt-get update -y
        sudo apt-get install openssh-client wget gnupg -y
        # Add Docker GPG key
        wget -qO- https://get.docker.com/gpg | sudo apt-key add -
        
        # Fix libcrypto error by setting an explicit OpenSSL version (if needed)
        export OPENSSL_CONF=/etc/ssl/openssl.cnf
        
        # Start ssh-agent manually and add the SSH key
        eval $(ssh-agent -s)
        
        

    - name: Deploy to Compute Engine Instance
      run: |
        # Define variables
        INSTANCE_NAME="demo-poc"
        ZONE="us-central1-b"  # Replace with your instance's zone
        SSH_USER="your-email"  # Replace with the user for the instance
        SSH_KEY="${{ secrets.GCP_SSH_PRIVATE_KEY }}"  # Add private SSH key to secrets
        DEPLOY_SCRIPT="Script.sh"  # Script to run on the instance

        echo "$GCP_SSH_PRIVATE_KEY"


        sudo apt-get install apt-transport-https ca-certificates gnupg curl
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        sudo apt-get update && sudo apt-get install google-cloud-cli

        
